openapi: 3.0.3
info:
  title: Income Tax API
  version: 1.0.0
  description: |
    The Income Tax API manages income tax returns, assessments, and calculations within the UK tax system.
    
    This API provides endpoints for submitting tax returns, retrieving assessment details,
    and managing income tax calculations for taxpayers.
    
    ## Key Features
    - Tax return submission and management
    - Tax assessment tracking and retrieval
    - Income and tax calculation management
    - Cross-API relationships to Taxpayer and Payment APIs
    - Support for including related resources via the `include` parameter
    
    ## Relationships
    Income Tax resources include links to:
    - **Taxpayer** (Taxpayer API): The taxpayer who filed the return
    - **Payments** (Payment API): Payment allocations for tax returns
    
    ## Version History
    - 1.0.0: Initial release with core income tax management functionality
  contact:
    name: UK Tax Domain API Team
    email: api-support@example.gov.uk

servers:
  - url: http://localhost:8082
    description: Local mock server (Prism)
  - url: http://domain-api.execute-api.localhost.localstack.cloud:4566/dev
    description: Local gateway (LocalStack API Gateway with custom domain)

security:
  - {}  # Allow unauthenticated access for POC

tags:
  - name: tax-returns
    description: Tax return submission and management
  - name: assessments
    description: Tax assessment tracking and retrieval

paths:
  /tax-returns:
    get:
      summary: List tax returns
      description: |
        Retrieve a list of tax returns in the system.
        
        Supports filtering by taxpayer ID, tax year, and status.
        Supports including related resources from other APIs using the `include` parameter.
      operationId: listTaxReturns
      tags:
        - tax-returns
      parameters:
        - name: taxpayerId
          in: query
          description: Filter by taxpayer ID
          required: false
          schema:
            type: string
            pattern: '^TP[0-9]{6}$'
          example: "TP123456"
        - name: taxYear
          in: query
          description: Filter by tax year (format YYYY-YY)
          required: false
          schema:
            type: string
            pattern: '^[0-9]{4}-[0-9]{2}$'
          example: "2023-24"
        - name: status
          in: query
          description: Filter by return status
          required: false
          schema:
            type: string
            enum:
              - draft
              - submitted
              - assessed
              - closed
          example: "assessed"
        - $ref: '../shared/shared-components.yaml#/components/parameters/IncludeParameter'
      responses:
        '200':
          description: List of tax returns retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - items
                  - _links
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaxReturn'
                  _included:
                    type: object
                    description: |
                      Related resources included in the response when the `include` parameter is used.
                      Each property is a relationship name containing an array of related resources.
                    additionalProperties:
                      type: array
                      items:
                        type: object
                  _links:
                    type: object
                    required:
                      - self
                    properties:
                      self:
                        type: string
                        format: uri
              examples:
                withoutIncludes:
                  summary: List of tax returns without includes
                  value:
                    items:
                      - id: "TR20230001"
                        type: "tax-return"
                        taxpayerId: "TP123456"
                        taxYear: "2023-24"
                        period:
                          startDate: "2023-04-06"
                          endDate: "2024-04-05"
                        status: "assessed"
                        totalIncome:
                          amount: 50000.00
                          currency: "GBP"
                        taxDue:
                          amount: 7500.00
                          currency: "GBP"
                        _links:
                          self: "/tax-returns/TR20230001"
                          taxpayer:
                            href: "/taxpayers/TP123456"
                            type: "taxpayer"
                            title: "Taxpayer who filed this return"
                          assessments:
                            href: "/tax-returns/TR20230001/assessments"
                            type: "collection"
                            title: "Assessments for this return"
                          allocations:
                            href: "/allocations?taxReturnId=TR20230001"
                            type: "collection"
                            title: "Payment allocations for this return"
                    _links:
                      self: "/tax-returns"
                withIncludes:
                  summary: List of tax returns with included taxpayer and assessments
                  value:
                    items:
                      - id: "TR20230001"
                        type: "tax-return"
                        taxpayerId: "TP123456"
                        taxYear: "2023-24"
                        period:
                          startDate: "2023-04-06"
                          endDate: "2024-04-05"
                        status: "assessed"
                        totalIncome:
                          amount: 50000.00
                          currency: "GBP"
                        taxDue:
                          amount: 7500.00
                          currency: "GBP"
                        _links:
                          self: "/tax-returns/TR20230001"
                          taxpayer:
                            href: "/taxpayers/TP123456"
                            type: "taxpayer"
                            title: "Taxpayer who filed this return"
                          assessments:
                            href: "/tax-returns/TR20230001/assessments"
                            type: "collection"
                            title: "Assessments for this return"
                    _included:
                      taxpayer:
                        - id: "TP123456"
                          type: "taxpayer"
                          nino: "AB123456C"
                          name:
                            firstName: "John"
                            lastName: "Smith"
                          _links:
                            self: "/taxpayers/TP123456"
                      assessments:
                        - id: "AS20230001"
                          type: "assessment"
                          taxReturnId: "TR20230001"
                          assessmentDate: "2024-01-15T10:30:00Z"
                          taxDue:
                            amount: 7500.00
                            currency: "GBP"
                          dueDate: "2024-01-31"
                          _links:
                            self: "/assessments/AS20230001"
                    _links:
                      self: "/tax-returns?include=taxpayer,assessments"
        '400':
          $ref: '../shared/shared-components.yaml#/components/responses/BadRequest'

    post:
      summary: Submit a new tax return
      description: |
        Submit a new income tax return for a taxpayer.
        
        Requires a valid taxpayer ID and tax year. The tax year must be in the format YYYY-YY
        (e.g., 2023-24 for the tax year from 6 April 2023 to 5 April 2024).
      operationId: createTaxReturn
      tags:
        - tax-returns
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaxReturnCreate'
            examples:
              minimal:
                summary: Minimal tax return submission
                value:
                  taxpayerId: "TP123456"
                  taxYear: "2023-24"
                  totalIncome:
                    amount: 50000.00
                    currency: "GBP"
              complete:
                summary: Complete tax return with all fields
                value:
                  taxpayerId: "TP123456"
                  taxYear: "2023-24"
                  period:
                    startDate: "2023-04-06"
                    endDate: "2024-04-05"
                  totalIncome:
                    amount: 50000.00
                    currency: "GBP"
                  taxDue:
                    amount: 7500.00
                    currency: "GBP"
      responses:
        '201':
          description: Tax return submitted successfully
          headers:
            Location:
              description: URL of the newly created tax return
              schema:
                type: string
                format: uri
              example: "/tax-returns/TR20230001"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaxReturn'
              example:
                id: "TR20230001"
                type: "tax-return"
                taxpayerId: "TP123456"
                taxYear: "2023-24"
                period:
                  startDate: "2023-04-06"
                  endDate: "2024-04-05"
                status: "submitted"
                totalIncome:
                  amount: 50000.00
                  currency: "GBP"
                taxDue:
                  amount: 7500.00
                  currency: "GBP"
                _links:
                  self: "/tax-returns/TR20230001"
                  taxpayer:
                    href: "/taxpayers/TP123456"
                    type: "taxpayer"
                    title: "Taxpayer who filed this return"
                  assessments:
                    href: "/tax-returns/TR20230001/assessments"
                    type: "collection"
                    title: "Assessments for this return"
                  allocations:
                    href: "/allocations?taxReturnId=TR20230001"
                    type: "collection"
                    title: "Payment allocations for this return"
        '400':
          $ref: '../shared/shared-components.yaml#/components/responses/BadRequest'

  /tax-returns/{id}:
    parameters:
      - name: id
        in: path
        description: Unique tax return identifier
        required: true
        schema:
          type: string
          pattern: '^TR[0-9]{8}$'
        example: "TR20230001"

    get:
      summary: Get tax return details
      description: |
        Retrieve detailed information about a specific tax return.
        
        Supports including related resources from other APIs using the `include` parameter.
      operationId: getTaxReturn
      tags:
        - tax-returns
      parameters:
        - $ref: '../shared/shared-components.yaml#/components/parameters/IncludeParameter'
      responses:
        '200':
          description: Tax return details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaxReturnWithIncludes'
              examples:
                withoutIncludes:
                  summary: Tax return without includes
                  value:
                    id: "TR20230001"
                    type: "tax-return"
                    taxpayerId: "TP123456"
                    taxYear: "2023-24"
                    period:
                      startDate: "2023-04-06"
                      endDate: "2024-04-05"
                    status: "assessed"
                    totalIncome:
                      amount: 50000.00
                      currency: "GBP"
                    taxDue:
                      amount: 7500.00
                      currency: "GBP"
                    _links:
                      self: "/tax-returns/TR20230001"
                      taxpayer:
                        href: "/taxpayers/TP123456"
                        type: "taxpayer"
                        title: "Taxpayer who filed this return"
                      assessments:
                        href: "/tax-returns/TR20230001/assessments"
                        type: "collection"
                        title: "Assessments for this return"
                      allocations:
                        href: "/allocations?taxReturnId=TR20230001"
                        type: "collection"
                        title: "Payment allocations for this return"
                withIncludes:
                  summary: Tax return with included taxpayer and assessments
                  value:
                    id: "TR20230001"
                    type: "tax-return"
                    taxpayerId: "TP123456"
                    taxYear: "2023-24"
                    period:
                      startDate: "2023-04-06"
                      endDate: "2024-04-05"
                    status: "assessed"
                    totalIncome:
                      amount: 50000.00
                      currency: "GBP"
                    taxDue:
                      amount: 7500.00
                      currency: "GBP"
                    _links:
                      self: "/tax-returns/TR20230001"
                      taxpayer:
                        href: "/taxpayers/TP123456"
                        type: "taxpayer"
                        title: "Taxpayer who filed this return"
                      assessments:
                        href: "/tax-returns/TR20230001/assessments"
                        type: "collection"
                        title: "Assessments for this return"
                      allocations:
                        href: "/allocations?taxReturnId=TR20230001"
                        type: "collection"
                        title: "Payment allocations for this return"
                    _includes:
                      taxpayer: ["TP123456"]
                      assessments: ["AS20230001"]
                    _included:
                      taxpayer:
                        - id: "TP123456"
                          type: "taxpayer"
                          nino: "AB123456C"
                          name:
                            firstName: "John"
                            lastName: "Smith"
                          address:
                            line1: "10 Downing Street"
                            postcode: "SW1A 2AA"
                            country: "GB"
                          _links:
                            self: "/taxpayers/TP123456"
                            taxReturns:
                              href: "/tax-returns?taxpayerId=TP123456"
                              type: "collection"
                              title: "Tax returns for this taxpayer"
                      assessments:
                        - id: "AS20230001"
                          type: "assessment"
                          taxReturnId: "TR20230001"
                          assessmentDate: "2024-01-15T10:30:00Z"
                          taxDue:
                            amount: 7500.00
                            currency: "GBP"
                          dueDate: "2024-01-31"
                          _links:
                            self: "/assessments/AS20230001"
                            taxReturn:
                              href: "/tax-returns/TR20230001"
                              type: "tax-return"
                              title: "Tax return for this assessment"
        '404':
          $ref: '../shared/shared-components.yaml#/components/responses/NotFound'

  /tax-returns/{id}/assessments:
    parameters:
      - name: id
        in: path
        description: Unique tax return identifier
        required: true
        schema:
          type: string
          pattern: '^TR[0-9]{8}$'
        example: "TR20230001"

    get:
      summary: Get assessments for a tax return
      description: |
        Retrieve all assessments associated with a specific tax return.
        
        A tax return may have multiple assessments if it has been amended or reassessed.
      operationId: getTaxReturnAssessments
      tags:
        - assessments
      responses:
        '200':
          description: List of assessments retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - items
                  - _links
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Assessment'
                  _links:
                    type: object
                    required:
                      - self
                    properties:
                      self:
                        type: string
                        format: uri
              example:
                items:
                  - id: "AS20230001"
                    type: "assessment"
                    taxReturnId: "TR20230001"
                    assessmentDate: "2024-01-15T10:30:00Z"
                    taxDue:
                      amount: 7500.00
                      currency: "GBP"
                    dueDate: "2024-01-31"
                    _links:
                      self: "/assessments/AS20230001"
                      taxReturn:
                        href: "/tax-returns/TR20230001"
                        type: "tax-return"
                        title: "Tax return for this assessment"
                _links:
                  self: "/tax-returns/TR20230001/assessments"
        '404':
          $ref: '../shared/shared-components.yaml#/components/responses/NotFound'

  /assessments/{id}:
    parameters:
      - name: id
        in: path
        description: Unique assessment identifier
        required: true
        schema:
          type: string
          pattern: '^AS[0-9]{8}$'
        example: "AS20230001"

    get:
      summary: Get assessment details
      description: |
        Retrieve detailed information about a specific tax assessment.
        
        Supports including related resources using the `include` parameter.
      operationId: getAssessment
      tags:
        - assessments
      parameters:
        - $ref: '../shared/shared-components.yaml#/components/parameters/IncludeParameter'
      responses:
        '200':
          description: Assessment details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssessmentWithIncludes'
              examples:
                withoutIncludes:
                  summary: Assessment without includes
                  value:
                    id: "AS20230001"
                    type: "assessment"
                    taxReturnId: "TR20230001"
                    assessmentDate: "2024-01-15T10:30:00Z"
                    taxDue:
                      amount: 7500.00
                      currency: "GBP"
                    dueDate: "2024-01-31"
                    _links:
                      self: "/assessments/AS20230001"
                      taxReturn:
                        href: "/tax-returns/TR20230001"
                        type: "tax-return"
                        title: "Tax return for this assessment"
                withIncludes:
                  summary: Assessment with included tax return
                  value:
                    id: "AS20230001"
                    type: "assessment"
                    taxReturnId: "TR20230001"
                    assessmentDate: "2024-01-15T10:30:00Z"
                    taxDue:
                      amount: 7500.00
                      currency: "GBP"
                    dueDate: "2024-01-31"
                    _links:
                      self: "/assessments/AS20230001"
                      taxReturn:
                        href: "/tax-returns/TR20230001"
                        type: "tax-return"
                        title: "Tax return for this assessment"
                    _includes:
                      taxReturn: ["TR20230001"]
                    _included:
                      taxReturn:
                        - id: "TR20230001"
                          type: "tax-return"
                          taxpayerId: "TP123456"
                          taxYear: "2023-24"
                          status: "assessed"
                          totalIncome:
                            amount: 50000.00
                            currency: "GBP"
                          taxDue:
                            amount: 7500.00
                            currency: "GBP"
                          _links:
                            self: "/tax-returns/TR20230001"
                            taxpayer:
                              href: "/taxpayers/TP123456"
                              type: "taxpayer"
                              title: "Taxpayer who filed this return"
        '404':
          $ref: '../shared/shared-components.yaml#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT bearer token authentication (not implemented in POC).
        
        In production, all endpoints would require authentication.

  schemas:
    TaxReturn:
      type: object
      description: |
        An income tax return submitted by a taxpayer for a specific tax year.
        
        Contains income information, tax calculations, and status tracking.
        Includes hypermedia links to related resources in other domain APIs.
      required:
        - id
        - type
        - taxpayerId
        - taxYear
        - status
        - _links
      properties:
        id:
          type: string
          pattern: '^TR[0-9]{8}$'
          description: Unique tax return identifier
          example: "TR20230001"
        type:
          type: string
          enum:
            - tax-return
          description: Resource type identifier
          example: "tax-return"
        taxpayerId:
          type: string
          pattern: '^TP[0-9]{6}$'
          description: ID of the taxpayer who filed this return
          example: "TP123456"
        taxYear:
          type: string
          pattern: '^[0-9]{4}-[0-9]{2}$'
          description: |
            UK tax year in format YYYY-YY.
            
            The UK tax year runs from 6 April to 5 April the following year.
            For example, "2023-24" represents the period from 6 April 2023 to 5 April 2024.
          example: "2023-24"
        period:
          $ref: '../shared/shared-components.yaml#/components/schemas/DateRange'
          description: |
            The actual date range covered by this tax return.
            Typically aligns with the tax year (6 April to 5 April).
        status:
          type: string
          enum:
            - draft
            - submitted
            - assessed
            - closed
          description: |
            Current status of the tax return:
            - draft: Return is being prepared but not yet submitted
            - submitted: Return has been submitted and is awaiting assessment
            - assessed: Return has been assessed and tax due calculated
            - closed: Return is finalized and all tax has been paid
          example: "assessed"
        totalIncome:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
          description: Total income reported for the tax year
        taxDue:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
          description: Total tax due based on the return (may be updated by assessment)
        _links:
          allOf:
            - $ref: '../shared/shared-components.yaml#/components/schemas/Links'
            - type: object
              description: |
                Hypermedia links to related resources.
                
                Includes links to:
                - self: This tax return resource
                - taxpayer: The taxpayer who filed this return (Taxpayer API)
                - assessments: Assessments for this return (Income Tax API)
                - allocations: Payment allocations for this return (Payment API)
              properties:
                taxpayer:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to the taxpayer who filed this return
                      example: "/taxpayers/TP123456"
                    type:
                      type: string
                      enum:
                        - taxpayer
                      example: "taxpayer"
                    title:
                      type: string
                      example: "Taxpayer who filed this return"
                assessments:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to assessments for this return
                      example: "/tax-returns/TR20230001/assessments"
                    type:
                      type: string
                      enum:
                        - collection
                      example: "collection"
                    title:
                      type: string
                      example: "Assessments for this return"
                allocations:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to payment allocations for this return
                      example: "/allocations?taxReturnId=TR20230001"
                    type:
                      type: string
                      enum:
                        - collection
                      example: "collection"
                    title:
                      type: string
                      example: "Payment allocations for this return"

    TaxReturnWithIncludes:
      allOf:
        - $ref: '#/components/schemas/TaxReturn'
        - type: object
          description: Tax return with optional included related resources
          properties:
            _includes:
              type: object
              description: |
                References to included resources by relationship name.
                Each property contains an array of IDs referencing resources in _included.
              properties:
                taxpayer:
                  type: array
                  items:
                    type: string
                    pattern: '^TP[0-9]{6}$'
                  example: ["TP123456"]
                assessments:
                  type: array
                  items:
                    type: string
                    pattern: '^AS[0-9]{8}$'
                  example: ["AS20230001"]
                allocations:
                  type: array
                  items:
                    type: string
                    pattern: '^PA[0-9]{8}$'
                  example: ["PA20230001"]
            _included:
              type: object
              description: |
                Related resources included in the response.
                Each property is a relationship name containing an array of related resources.
              properties:
                taxpayer:
                  type: array
                  description: Taxpayer who filed this return
                  items:
                    type: object
                    description: Taxpayer resource from Taxpayer API
                assessments:
                  type: array
                  description: Assessments for this return
                  items:
                    type: object
                    description: Assessment resource from Income Tax API
                allocations:
                  type: array
                  description: Payment allocations for this return
                  items:
                    type: object
                    description: Payment allocation resource from Payment API

    TaxReturnCreate:
      type: object
      description: Request body for submitting a new tax return
      required:
        - taxpayerId
        - taxYear
        - totalIncome
      properties:
        taxpayerId:
          type: string
          pattern: '^TP[0-9]{6}$'
          description: ID of the taxpayer filing this return
          example: "TP123456"
        taxYear:
          type: string
          pattern: '^[0-9]{4}-[0-9]{2}$'
          description: UK tax year in format YYYY-YY
          example: "2023-24"
        period:
          $ref: '../shared/shared-components.yaml#/components/schemas/DateRange'
          description: Date range covered by this return (optional, defaults to tax year dates)
        totalIncome:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
          description: Total income for the tax year
        taxDue:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
          description: Calculated tax due (optional, can be calculated by system)

    Assessment:
      type: object
      description: |
        A tax assessment issued by HMRC for a tax return.
        
        An assessment calculates the final tax due and sets a payment deadline.
        A tax return may have multiple assessments if it is amended or reassessed.
      required:
        - id
        - type
        - taxReturnId
        - assessmentDate
        - taxDue
        - _links
      properties:
        id:
          type: string
          pattern: '^AS[0-9]{8}$'
          description: Unique assessment identifier
          example: "AS20230001"
        type:
          type: string
          enum:
            - assessment
          description: Resource type identifier
          example: "assessment"
        taxReturnId:
          type: string
          pattern: '^TR[0-9]{8}$'
          description: ID of the tax return being assessed
          example: "TR20230001"
        assessmentDate:
          type: string
          format: date-time
          description: Date and time when the assessment was issued
          example: "2024-01-15T10:30:00Z"
        taxDue:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
          description: Total tax due according to this assessment
        dueDate:
          type: string
          format: date
          description: Date by which the tax must be paid
          example: "2024-01-31"
        _links:
          allOf:
            - $ref: '../shared/shared-components.yaml#/components/schemas/Links'
            - type: object
              description: |
                Hypermedia links to related resources.
                
                Includes links to:
                - self: This assessment resource
                - taxReturn: The tax return being assessed (Income Tax API)
              properties:
                taxReturn:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to the tax return for this assessment
                      example: "/tax-returns/TR20230001"
                    type:
                      type: string
                      enum:
                        - tax-return
                      example: "tax-return"
                    title:
                      type: string
                      example: "Tax return for this assessment"

    AssessmentWithIncludes:
      allOf:
        - $ref: '#/components/schemas/Assessment'
        - type: object
          description: Assessment with optional included related resources
          properties:
            _includes:
              type: object
              description: |
                References to included resources by relationship name.
                Each property contains an array of IDs referencing resources in _included.
              properties:
                taxReturn:
                  type: array
                  items:
                    type: string
                    pattern: '^TR[0-9]{8}$'
                  example: ["TR20230001"]
            _included:
              type: object
              description: |
                Related resources included in the response.
                Each property is a relationship name containing an array of related resources.
              properties:
                taxReturn:
                  type: array
                  description: Tax return for this assessment
                  items:
                    type: object
                    description: Tax return resource from Income Tax API
