openapi: 3.0.3
info:
  title: Shared Components
  version: 1.0.0
  description: |
    Reusable OpenAPI components shared across UK Tax Domain APIs.
    
    This file contains common schemas, parameters, and response definitions
    that are referenced by multiple domain APIs (Taxpayer, Income Tax, Payment).
    
    Version History:
    - 1.0.0: Initial release with Address, Money, DateRange, and Links schemas

components:
  schemas:
    Address:
      type: object
      description: UK postal address with postcode validation
      required:
        - line1
        - postcode
        - country
      properties:
        line1:
          type: string
          description: First line of address
          example: "10 Downing Street"
          minLength: 1
          maxLength: 100
        line2:
          type: string
          description: Second line of address (optional)
          example: "Westminster"
          maxLength: 100
        line3:
          type: string
          description: Third line of address (optional)
          example: "London"
          maxLength: 100
        postcode:
          type: string
          description: UK postcode in standard format
          pattern: '^[A-Z]{1,2}[0-9][A-Z0-9]? ?[0-9][A-Z]{2}$'
          example: "SW1A 2AA"
        country:
          type: string
          description: Country code (GB or UK accepted)
          enum:
            - GB
            - UK
          example: "GB"
      example:
        line1: "10 Downing Street"
        line2: "Westminster"
        line3: "London"
        postcode: "SW1A 2AA"
        country: "GB"

    Money:
      type: object
      description: Monetary amount in GBP currency
      required:
        - amount
        - currency
      properties:
        amount:
          type: number
          format: decimal
          description: Monetary amount with up to 2 decimal places
          example: 1234.56
          minimum: 0
        currency:
          type: string
          description: Currency code (GBP only for UK tax system)
          enum:
            - GBP
          default: GBP
          example: "GBP"
      example:
        amount: 1234.56
        currency: "GBP"

    DateRange:
      type: object
      description: Date range with start and end dates
      required:
        - startDate
        - endDate
      properties:
        startDate:
          type: string
          format: date
          description: Start date in ISO 8601 format (YYYY-MM-DD)
          example: "2023-04-06"
        endDate:
          type: string
          format: date
          description: End date in ISO 8601 format (YYYY-MM-DD)
          example: "2024-04-05"
      example:
        startDate: "2023-04-06"
        endDate: "2024-04-05"

    Links:
      type: object
      description: |
        Hypermedia links to related resources following a lightweight JSON API-inspired approach.
        
        The 'self' link is always present and points to the current resource.
        Additional links represent relationships to other resources, which may be in the same
        or different domain APIs.
        
        Links use uri-reference format (RFC 3986), which allows both absolute URIs and 
        relative references (path-only URLs). Path-only URLs are preferred for flexibility
        and to avoid coupling to specific hostnames.
        
        Each link object contains:
        - href: The URL to the related resource (path-only or absolute)
        - type: The resource type or 'collection' for lists (optional)
        - title: Human-readable description of the relationship (optional)
      required:
        - self
      properties:
        self:
          type: string
          format: uri-reference
          description: URL to the current resource (path-only or absolute)
          example: "/dev/taxpayers/TP123456"
      additionalProperties:
        oneOf:
          - type: string
            format: uri-reference
            description: Simple link as a string URL (path-only or absolute)
          - type: object
            description: Detailed link object with metadata
            required:
              - href
            properties:
              href:
                type: string
                format: uri-reference
                description: URL to the related resource (path-only or absolute)
                example: "/dev/tax-returns?taxpayerId=TP123456"
              type:
                type: string
                description: Resource type or 'collection' for lists
                example: "collection"
              title:
                type: string
                description: Human-readable description of the relationship
                example: "Tax returns for this taxpayer"
      example:
        self: "/dev/taxpayers/TP123456"
        taxReturns:
          href: "/dev/tax-returns?taxpayerId=TP123456"
          type: "collection"
          title: "Tax returns for this taxpayer"
        payments:
          href: "/dev/payments?taxpayerId=TP123456"
          type: "collection"
          title: "Payments made by this taxpayer"

  parameters:
    IncludeParameter:
      name: include
      in: query
      description: |
        Comma-separated list of related resources to include in the response.
        
        When specified, the response will include an '_included' field containing
        the related resources, reducing the need for multiple API requests.
        
        ## Basic Usage
        Only relationships defined in the resource's '_links' field can be included.
        Cross-API includes are supported.
        
        Example: ?include=taxReturns,payments
        
        ## Nested Includes
        To include relationships of included resources, use dot notation to traverse
        the relationship graph. This allows fetching deeply nested related resources
        in a single request.
        
        Syntax: `relationshipName.nestedRelationshipName`
        
        Examples:
        - `?include=taxReturns.assessments` - Include tax returns and their assessments
        - `?include=taxReturns.assessments,taxReturns.allocations` - Include multiple nested relationships
        - `?include=taxReturns,taxReturns.assessments.payments` - Include multiple levels deep
        
        ## Nested Include Rules
        1. **Implicit Parent Inclusion**: Nested includes automatically include all parent resources in the path
           - `?include=taxReturns.assessments` includes BOTH taxReturns AND assessments
           - Rationale: Nested resources need parent context to be meaningful
           - Example: You cannot get assessments without the tax returns they belong to
        2. **Depth Limit**: Maximum nesting depth is 5 levels (configurable)
        3. **Relationship Validation**: Each level must be a valid relationship in the parent resource's '_links'
        4. **Deduplication**: Resources are deduplicated by type and ID across all include levels
        5. **Flat Structure**: All included resources are stored in a flat '_included' object, grouped by type
        6. **Reference Tracking**: Each resource includes an '_includes' field listing IDs of its included relationships
        
        ## Examples
        
        ### Single Level
        `?include=taxReturns`
        ```json
        {
          "id": "TP123456",
          "_links": {"taxReturns": {"href": "/tax-returns?taxpayerId=TP123456"}},
          "_includes": {"taxReturns": ["TR20230001"]},
          "_included": {
            "taxReturns": [{"id": "TR20230001", ...}]
          }
        }
        ```
        
        ### Nested Level
        `?include=taxReturns.assessments`
        ```json
        {
          "id": "TP123456",
          "_links": {"taxReturns": {"href": "/tax-returns?taxpayerId=TP123456"}},
          "_includes": {"taxReturns": ["TR20230001"]},
          "_included": {
            "taxReturns": [
              {
                "id": "TR20230001",
                "_links": {"assessments": {"href": "/assessments?taxReturnId=TR20230001"}},
                "_includes": {"assessments": ["AS20230001"]}
              }
            ],
            "assessments": [{"id": "AS20230001", ...}]
          }
        }
        ```
        
        ### Multiple Nested Relationships
        `?include=taxReturns,taxReturns.assessments,taxReturns.allocations`
        - Includes tax returns
        - Includes assessments for each tax return
        - Includes payment allocations for each tax return
        
        ## Performance Considerations
        - Each nested level requires additional API calls
        - Use nested includes judiciously to balance convenience vs. performance
        - Consider caching strategies for frequently accessed relationship paths
        - Monitor depth limit to prevent excessive API calls
      required: false
      schema:
        type: string
        pattern: '^[a-zA-Z][a-zA-Z0-9]*(\.[a-zA-Z][a-zA-Z0-9]*)*(,[a-zA-Z][a-zA-Z0-9]*(\.[a-zA-Z][a-zA-Z0-9]*)*)*$'
      example: "taxReturns,taxReturns.assessments"

  responses:
    NotFound:
      description: The requested resource was not found
      content:
        application/json:
          schema:
            type: object
            required:
              - error
            properties:
              error:
                type: object
                required:
                  - code
                  - message
                  - status
                properties:
                  code:
                    type: string
                    example: "RESOURCE_NOT_FOUND"
                  message:
                    type: string
                    example: "Tax return TR20230001 not found"
                  status:
                    type: integer
                    example: 404
          example:
            error:
              code: "RESOURCE_NOT_FOUND"
              message: "Tax return TR20230001 not found"
              status: 404

    BadRequest:
      description: The request was invalid or malformed
      content:
        application/json:
          schema:
            type: object
            required:
              - error
            properties:
              error:
                type: object
                required:
                  - code
                  - message
                  - status
                properties:
                  code:
                    type: string
                    example: "VALIDATION_ERROR"
                  message:
                    type: string
                    example: "Invalid request data"
                  status:
                    type: integer
                    example: 400
                  details:
                    type: array
                    items:
                      type: object
                      properties:
                        field:
                          type: string
                          example: "nino"
                        message:
                          type: string
                          example: "Must match pattern ^[A-Z]{2}[0-9]{6}[A-Z]$"
          example:
            error:
              code: "VALIDATION_ERROR"
              message: "Invalid request data"
              status: 400
              details:
                - field: "nino"
                  message: "Must match pattern ^[A-Z]{2}[0-9]{6}[A-Z]$"

    BadGateway:
      description: Unable to reach upstream API
      content:
        application/json:
          schema:
            type: object
            required:
              - error
            properties:
              error:
                type: object
                required:
                  - code
                  - message
                  - status
                properties:
                  code:
                    type: string
                    example: "UPSTREAM_API_ERROR"
                  message:
                    type: string
                    example: "Unable to reach Income Tax API"
                  status:
                    type: integer
                    example: 502
                  upstreamService:
                    type: string
                    example: "income-tax-api"
          example:
            error:
              code: "UPSTREAM_API_ERROR"
              message: "Unable to reach Income Tax API"
              status: 502
              upstreamService: "income-tax-api"
