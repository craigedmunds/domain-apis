openapi: 3.0.3
info:
  title: Payment API
  version: 1.0.0
  description: |
    The Payment API manages tax payments and payment allocations within the UK tax system.
    
    This API provides endpoints for recording payments, retrieving payment details, and managing
    payment allocations to tax returns. It supports various payment methods and tracks payment
    status throughout the payment lifecycle.
    
    ## Key Features
    - Payment recording and tracking
    - Multiple payment methods (bank transfer, debit card, cheque)
    - Payment allocation to tax returns
    - Payment status management (pending, cleared, failed, refunded)
    - Cross-API relationships to Taxpayer and Income Tax APIs
    - Support for including related resources via the `include` parameter
    
    ## Relationships
    Payment resources include links to:
    - **Taxpayer** (Taxpayer API): The taxpayer who made the payment
    - **Allocations** (Payment API): How the payment is allocated to tax returns
    
    PaymentAllocation resources include links to:
    - **Payment** (Payment API): The payment being allocated
    - **Tax Return** (Income Tax API): The tax return receiving the allocation
    
    ## Version History
    - 1.0.0: Initial release with core payment management functionality
  contact:
    name: UK Tax Domain API Team
    email: api-support@example.gov.uk

servers:
  - url: http://localhost:4566
    description: "Gateway API (aggregated with includes) - Default"
  - url: http://localhost:4566
    description: "Gateway API (simple REST, use Accept: application/json)"
  - url: http://localhost:4566
    description: "Gateway API (pass-through, use Accept: application/vnd.raw)"

security:
  - {}  # Allow unauthenticated access for POC

tags:
  - name: payments
    description: Tax payment recording and management
  - name: allocations
    description: Payment allocation to tax returns

paths:
  /payments:
    get:
      summary: List payments
      description: |
        Retrieve a list of all payments in the system.
        
        Supports filtering by taxpayer and including related resources
        from other APIs using the `include` parameter.
      operationId: listPayments
      tags:
        - payments
      parameters:
        - name: taxpayerId
          in: query
          description: Filter by taxpayer ID
          required: false
          schema:
            type: string
            pattern: '^TP[0-9]{6}$'
          example: "TP123456"
        - name: status
          in: query
          description: Filter by payment status
          required: false
          schema:
            type: string
            enum:
              - pending
              - cleared
              - failed
              - refunded
          example: "cleared"
        - $ref: '../shared/shared-components.yaml#/components/parameters/IncludeParameter'
      responses:
        '200':
          description: List of payments retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - items
                  - _links
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Payment'
                  _included:
                    type: object
                    description: |
                      Related resources included in the response when the `include` parameter is used.
                      Each property is a relationship name containing an array of related resources.
                    additionalProperties:
                      type: array
                      items:
                        type: object
                  _links:
                    type: object
                    required:
                      - self
                    properties:
                      self:
                        type: string
                        format: uri
              examples:
                withoutIncludes:
                  summary: List of payments without includes
                  value:
                    items:
                      - id: "PM20230001"
                        type: "payment"
                        taxpayerId: "TP123456"
                        amount:
                          amount: 7500.00
                          currency: "GBP"
                        paymentDate: "2024-01-31"
                        paymentMethod: "bank-transfer"
                        reference: "TAX-2023-001"
                        status: "cleared"
                        _links:
                          self: "/payments/PM20230001"
                          taxpayer:
                            href: "/taxpayers/TP123456"
                            type: "taxpayer"
                            title: "Taxpayer who made this payment"
                          allocations:
                            href: "/payments/PM20230001/allocations"
                            type: "collection"
                            title: "Allocations for this payment"
                      - id: "PM20230002"
                        type: "payment"
                        taxpayerId: "TP789012"
                        amount:
                          amount: 3200.00
                          currency: "GBP"
                        paymentDate: "2024-02-15"
                        paymentMethod: "debit-card"
                        reference: "TAX-2023-002"
                        status: "cleared"
                        _links:
                          self: "/payments/PM20230002"
                          taxpayer:
                            href: "/taxpayers/TP789012"
                            type: "taxpayer"
                            title: "Taxpayer who made this payment"
                          allocations:
                            href: "/payments/PM20230002/allocations"
                            type: "collection"
                            title: "Allocations for this payment"
                    _links:
                      self: "/payments"
                withIncludes:
                  summary: List of payments with included taxpayers
                  value:
                    items:
                      - id: "PM20230001"
                        type: "payment"
                        taxpayerId: "TP123456"
                        amount:
                          amount: 7500.00
                          currency: "GBP"
                        paymentDate: "2024-01-31"
                        paymentMethod: "bank-transfer"
                        reference: "TAX-2023-001"
                        status: "cleared"
                        _links:
                          self: "/payments/PM20230001"
                          taxpayer:
                            href: "/taxpayers/TP123456"
                            type: "taxpayer"
                            title: "Taxpayer who made this payment"
                          allocations:
                            href: "/payments/PM20230001/allocations"
                            type: "collection"
                            title: "Allocations for this payment"
                    _included:
                      taxpayer:
                        - id: "TP123456"
                          type: "taxpayer"
                          nino: "AB123456C"
                          name:
                            firstName: "John"
                            lastName: "Smith"
                          _links:
                            self: "/taxpayers/TP123456"
                    _links:
                      self: "/payments?include=taxpayer"
        '400':
          $ref: '../shared/shared-components.yaml#/components/responses/BadRequest'

    post:
      summary: Record a new payment
      description: |
        Record a new tax payment in the system.
        
        Requires taxpayer ID, payment amount, date, and method.
        The payment can later be allocated to specific tax returns.
      operationId: createPayment
      tags:
        - payments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentCreate'
            examples:
              bankTransfer:
                summary: Bank transfer payment
                value:
                  taxpayerId: "TP123456"
                  amount:
                    amount: 7500.00
                    currency: "GBP"
                  paymentDate: "2024-01-31"
                  paymentMethod: "bank-transfer"
                  reference: "TAX-2023-001"
              debitCard:
                summary: Debit card payment
                value:
                  taxpayerId: "TP789012"
                  amount:
                    amount: 3200.00
                    currency: "GBP"
                  paymentDate: "2024-02-15"
                  paymentMethod: "debit-card"
                  reference: "TAX-2023-002"
      responses:
        '201':
          description: Payment recorded successfully
          headers:
            Location:
              description: URL of the newly created payment
              schema:
                type: string
                format: uri
              example: "/payments/PM20230001"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
              example:
                id: "PM20230001"
                type: "payment"
                taxpayerId: "TP123456"
                amount:
                  amount: 7500.00
                  currency: "GBP"
                paymentDate: "2024-01-31"
                paymentMethod: "bank-transfer"
                reference: "TAX-2023-001"
                status: "pending"
                _links:
                  self: "/payments/PM20230001"
                  taxpayer:
                    href: "/taxpayers/TP123456"
                    type: "taxpayer"
                    title: "Taxpayer who made this payment"
                  allocations:
                    href: "/payments/PM20230001/allocations"
                    type: "collection"
                    title: "Allocations for this payment"
        '400':
          $ref: '../shared/shared-components.yaml#/components/responses/BadRequest'

  /payments/{id}:
    parameters:
      - name: id
        in: path
        description: Unique payment identifier
        required: true
        schema:
          type: string
          pattern: '^PM[0-9]{8}$'
        example: "PM20230001"

    get:
      summary: Get payment details
      description: |
        Retrieve detailed information about a specific payment.
        
        Supports including related resources from other APIs using the `include` parameter.
      operationId: getPayment
      tags:
        - payments
      parameters:
        - $ref: '../shared/shared-components.yaml#/components/parameters/IncludeParameter'
      responses:
        '200':
          description: Payment details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentWithIncludes'
              examples:
                withoutIncludes:
                  summary: Payment without includes
                  value:
                    id: "PM20230001"
                    type: "payment"
                    taxpayerId: "TP123456"
                    amount:
                      amount: 7500.00
                      currency: "GBP"
                    paymentDate: "2024-01-31"
                    paymentMethod: "bank-transfer"
                    reference: "TAX-2023-001"
                    status: "cleared"
                    _links:
                      self: "/payments/PM20230001"
                      taxpayer:
                        href: "/taxpayers/TP123456"
                        type: "taxpayer"
                        title: "Taxpayer who made this payment"
                      allocations:
                        href: "/payments/PM20230001/allocations"
                        type: "collection"
                        title: "Allocations for this payment"
                withIncludes:
                  summary: Payment with included taxpayer and allocations
                  value:
                    id: "PM20230001"
                    type: "payment"
                    taxpayerId: "TP123456"
                    amount:
                      amount: 7500.00
                      currency: "GBP"
                    paymentDate: "2024-01-31"
                    paymentMethod: "bank-transfer"
                    reference: "TAX-2023-001"
                    status: "cleared"
                    _links:
                      self: "/payments/PM20230001"
                      taxpayer:
                        href: "/taxpayers/TP123456"
                        type: "taxpayer"
                        title: "Taxpayer who made this payment"
                      allocations:
                        href: "/payments/PM20230001/allocations"
                        type: "collection"
                        title: "Allocations for this payment"
                    _includes:
                      taxpayer: ["TP123456"]
                      allocations: ["PA20230001"]
                    _included:
                      taxpayer:
                        - id: "TP123456"
                          type: "taxpayer"
                          nino: "AB123456C"
                          name:
                            firstName: "John"
                            lastName: "Smith"
                          _links:
                            self: "/taxpayers/TP123456"
                      allocations:
                        - id: "PA20230001"
                          type: "payment-allocation"
                          paymentId: "PM20230001"
                          taxReturnId: "TR20230001"
                          amount:
                            amount: 7500.00
                            currency: "GBP"
                          allocationDate: "2024-02-01T10:30:00Z"
                          _links:
                            self: "/allocations/PA20230001"
                            payment:
                              href: "/payments/PM20230001"
                              type: "payment"
                              title: "Payment for this allocation"
                            taxReturn:
                              href: "/tax-returns/TR20230001"
                              type: "tax-return"
                              title: "Tax return receiving this allocation"
        '404':
          $ref: '../shared/shared-components.yaml#/components/responses/NotFound'

  /payments/{id}/allocations:
    parameters:
      - name: id
        in: path
        description: Unique payment identifier
        required: true
        schema:
          type: string
          pattern: '^PM[0-9]{8}$'
        example: "PM20230001"

    get:
      summary: Get payment allocations
      description: |
        Retrieve all allocations for a specific payment.
        
        Shows how the payment has been allocated to different tax returns.
      operationId: getPaymentAllocations
      tags:
        - allocations
      responses:
        '200':
          description: Payment allocations retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - items
                  - _links
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/PaymentAllocation'
                  _links:
                    type: object
                    required:
                      - self
                    properties:
                      self:
                        type: string
                        format: uri
              example:
                items:
                  - id: "PA20230001"
                    type: "payment-allocation"
                    paymentId: "PM20230001"
                    taxReturnId: "TR20230001"
                    amount:
                      amount: 7500.00
                      currency: "GBP"
                    allocationDate: "2024-02-01T10:30:00Z"
                    _links:
                      self: "/allocations/PA20230001"
                      payment:
                        href: "/payments/PM20230001"
                        type: "payment"
                        title: "Payment for this allocation"
                      taxReturn:
                        href: "/tax-returns/TR20230001"
                        type: "tax-return"
                        title: "Tax return receiving this allocation"
                _links:
                  self: "/payments/PM20230001/allocations"
        '404':
          $ref: '../shared/shared-components.yaml#/components/responses/NotFound'

  /allocations:
    post:
      summary: Create a payment allocation
      description: |
        Allocate a payment (or part of a payment) to a specific tax return.
        
        This creates a link between a payment and a tax return, showing how
        the payment is applied to satisfy tax liabilities.
      operationId: createAllocation
      tags:
        - allocations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentAllocationCreate'
            examples:
              fullAllocation:
                summary: Full payment allocation
                value:
                  paymentId: "PM20230001"
                  taxReturnId: "TR20230001"
                  amount:
                    amount: 7500.00
                    currency: "GBP"
              partialAllocation:
                summary: Partial payment allocation
                value:
                  paymentId: "PM20230002"
                  taxReturnId: "TR20230002"
                  amount:
                    amount: 1500.00
                    currency: "GBP"
      responses:
        '201':
          description: Payment allocation created successfully
          headers:
            Location:
              description: URL of the newly created allocation
              schema:
                type: string
                format: uri
              example: "/allocations/PA20230001"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentAllocation'
              example:
                id: "PA20230001"
                type: "payment-allocation"
                paymentId: "PM20230001"
                taxReturnId: "TR20230001"
                amount:
                  amount: 7500.00
                  currency: "GBP"
                allocationDate: "2024-02-01T10:30:00Z"
                _links:
                  self: "/allocations/PA20230001"
                  payment:
                    href: "/payments/PM20230001"
                    type: "payment"
                    title: "Payment for this allocation"
                  taxReturn:
                    href: "/tax-returns/TR20230001"
                    type: "tax-return"
                    title: "Tax return receiving this allocation"
        '400':
          $ref: '../shared/shared-components.yaml#/components/responses/BadRequest'
        '404':
          description: Payment or tax return not found
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                properties:
                  error:
                    type: object
                    required:
                      - code
                      - message
                      - status
                    properties:
                      code:
                        type: string
                      message:
                        type: string
                      status:
                        type: integer
              example:
                error:
                  code: "RESOURCE_NOT_FOUND"
                  message: "Payment PM20230001 or tax return TR20230001 not found"
                  status: 404

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT bearer token authentication (not implemented in POC).
        
        In production, all endpoints would require authentication.

  schemas:
    Payment:
      type: object
      description: |
        A tax payment made by a taxpayer.
        
        Records payment details including amount, date, method, and status.
        Includes hypermedia links to related resources in other domain APIs.
      required:
        - id
        - type
        - taxpayerId
        - amount
        - paymentDate
        - paymentMethod
        - status
        - _links
      properties:
        id:
          type: string
          pattern: '^PM[0-9]{8}$'
          description: Unique payment identifier
          example: "PM20230001"
        type:
          type: string
          enum:
            - payment
          description: Resource type identifier
          example: "payment"
        taxpayerId:
          type: string
          pattern: '^TP[0-9]{6}$'
          description: ID of the taxpayer who made the payment
          example: "TP123456"
        amount:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
        paymentDate:
          type: string
          format: date
          description: Date the payment was made in ISO 8601 format (YYYY-MM-DD)
          example: "2024-01-31"
        paymentMethod:
          type: string
          enum:
            - bank-transfer
            - debit-card
            - cheque
          description: Method used to make the payment
          example: "bank-transfer"
        reference:
          type: string
          description: Payment reference or transaction ID
          example: "TAX-2023-001"
          maxLength: 100
        status:
          type: string
          enum:
            - pending
            - cleared
            - failed
            - refunded
          description: Current status of the payment
          example: "cleared"
        _links:
          allOf:
            - $ref: '../shared/shared-components.yaml#/components/schemas/Links'
            - type: object
              description: |
                Hypermedia links to related resources.
                
                Includes links to:
                - self: This payment resource
                - taxpayer: The taxpayer who made this payment (Taxpayer API)
                - allocations: How this payment is allocated to tax returns
              properties:
                taxpayer:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to the taxpayer resource
                      example: "/taxpayers/TP123456"
                    type:
                      type: string
                      enum:
                        - taxpayer
                      example: "taxpayer"
                    title:
                      type: string
                      example: "Taxpayer who made this payment"
                allocations:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to the payment's allocations
                      example: "/payments/PM20230001/allocations"
                    type:
                      type: string
                      enum:
                        - collection
                      example: "collection"
                    title:
                      type: string
                      example: "Allocations for this payment"

    PaymentWithIncludes:
      allOf:
        - $ref: '#/components/schemas/Payment'
        - type: object
          description: Payment with optional included related resources
          properties:
            _includes:
              type: object
              description: |
                References to included resources by relationship name.
                Each property contains an array of IDs referencing resources in _included.
              properties:
                taxpayer:
                  type: array
                  items:
                    type: string
                    pattern: '^TP[0-9]{6}$'
                  example: ["TP123456"]
                allocations:
                  type: array
                  items:
                    type: string
                    pattern: '^PA[0-9]{8}$'
                  example: ["PA20230001"]
            _included:
              type: object
              description: |
                Related resources included in the response.
                Each property is a relationship name containing an array of related resources.
              properties:
                taxpayer:
                  type: array
                  description: The taxpayer who made this payment
                  items:
                    type: object
                    description: Taxpayer resource from Taxpayer API
                allocations:
                  type: array
                  description: Allocations for this payment
                  items:
                    type: object
                    description: PaymentAllocation resource

    PaymentCreate:
      type: object
      description: Request body for recording a new payment
      required:
        - taxpayerId
        - amount
        - paymentDate
        - paymentMethod
      properties:
        taxpayerId:
          type: string
          pattern: '^TP[0-9]{6}$'
          description: ID of the taxpayer making the payment
          example: "TP123456"
        amount:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
        paymentDate:
          type: string
          format: date
          description: Date the payment was made
          example: "2024-01-31"
        paymentMethod:
          type: string
          enum:
            - bank-transfer
            - debit-card
            - cheque
          description: Method used to make the payment
          example: "bank-transfer"
        reference:
          type: string
          description: Payment reference or transaction ID (optional)
          example: "TAX-2023-001"
          maxLength: 100

    PaymentAllocation:
      type: object
      description: |
        An allocation of a payment to a specific tax return.
        
        Links a payment (or part of a payment) to a tax return, showing how
        the payment is applied to satisfy tax liabilities.
      required:
        - id
        - type
        - paymentId
        - taxReturnId
        - amount
        - allocationDate
        - _links
      properties:
        id:
          type: string
          pattern: '^PA[0-9]{8}$'
          description: Unique payment allocation identifier
          example: "PA20230001"
        type:
          type: string
          enum:
            - payment-allocation
          description: Resource type identifier
          example: "payment-allocation"
        paymentId:
          type: string
          pattern: '^PM[0-9]{8}$'
          description: ID of the payment being allocated
          example: "PM20230001"
        taxReturnId:
          type: string
          pattern: '^TR[0-9]{8}$'
          description: ID of the tax return receiving the allocation
          example: "TR20230001"
        amount:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
        allocationDate:
          type: string
          format: date-time
          description: Date and time the allocation was created in ISO 8601 format
          example: "2024-02-01T10:30:00Z"
        _links:
          allOf:
            - $ref: '../shared/shared-components.yaml#/components/schemas/Links'
            - type: object
              description: |
                Hypermedia links to related resources.
                
                Includes links to:
                - self: This allocation resource
                - payment: The payment being allocated (Payment API)
                - taxReturn: The tax return receiving the allocation (Income Tax API)
              properties:
                payment:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to the payment resource
                      example: "/payments/PM20230001"
                    type:
                      type: string
                      enum:
                        - payment
                      example: "payment"
                    title:
                      type: string
                      example: "Payment for this allocation"
                taxReturn:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to the tax return resource
                      example: "/tax-returns/TR20230001"
                    type:
                      type: string
                      enum:
                        - tax-return
                      example: "tax-return"
                    title:
                      type: string
                      example: "Tax return receiving this allocation"

    PaymentAllocationCreate:
      type: object
      description: Request body for creating a payment allocation
      required:
        - paymentId
        - taxReturnId
        - amount
      properties:
        paymentId:
          type: string
          pattern: '^PM[0-9]{8}$'
          description: ID of the payment to allocate
          example: "PM20230001"
        taxReturnId:
          type: string
          pattern: '^TR[0-9]{8}$'
          description: ID of the tax return to allocate to
          example: "TR20230001"
        amount:
          $ref: '../shared/shared-components.yaml#/components/schemas/Money'
