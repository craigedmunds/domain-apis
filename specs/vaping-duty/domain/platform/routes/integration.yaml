# VPD Domain API - Camel YAML DSL Routes
#
# Phase 7b: Full Orchestration
#
# GET by acknowledgementReference orchestration:
#   1. Call tax-platform to get submission (includes customerId)
#   2. Call customer service to get trader details (using customerId)
#   3. Combine into enriched response with trader field

# =============================================================================
# REST Configuration
# =============================================================================

- restConfiguration:
    component: platform-http
    bindingMode: off
    port: 8080

# =============================================================================
# REST Endpoints
# =============================================================================

- rest:
    path: /duty/vpd/submission-returns/v1
    get:
      - to: direct:getSubmission
    post:
      - to: direct:postSubmission

- rest:
    path: /health
    get:
      - to: direct:health

# =============================================================================
# Route: GET Submission - Entry point
# =============================================================================

- route:
    id: getSubmission
    from:
      uri: direct:getSubmission
      steps:
        # Store correlation ID and query params
        - setProperty:
            name: correlationId
            simple: "${header.X-Correlation-Id}"
        - setProperty:
            name: ackRef
            simple: "${header.acknowledgementReference}"
        - setProperty:
            name: approvalNumber
            simple: "${header.vpdApprovalNumber}"
        - setProperty:
            name: periodKey
            simple: "${header.periodKey}"

        # Route based on query parameters
        - choice:
            when:
              - simple: "${exchangeProperty.ackRef} != null"
                steps:
                  - to: direct:getByAcknowledgement
              - simple: "${exchangeProperty.approvalNumber} != null && ${exchangeProperty.periodKey} != null"
                steps:
                  - to: direct:getByApprovalAndPeriod
            otherwise:
              steps:
                - setHeader:
                    name: CamelHttpResponseCode
                    constant: 400
                - setBody:
                    constant: '{"code": "BAD_REQUEST", "message": "Either acknowledgementReference OR (vpdApprovalNumber AND periodKey) query parameters are required"}'
                - setHeader:
                    name: Content-Type
                    constant: "application/json"

# =============================================================================
# Route: GET by Acknowledgement Reference - ORCHESTRATED
# 1. tax-platform -> get submission
# 2. customer -> get trader details
# 3. Combine into enriched response
# =============================================================================

- route:
    id: getByAcknowledgement
    from:
      uri: direct:getByAcknowledgement
      steps:
        # Step 1: Call tax-platform to get submission
        - removeHeaders:
            pattern: "CamelHttp*"
        - setHeader:
            name: CamelHttpMethod
            constant: "GET"
        - setHeader:
            name: X-Correlation-Id
            simple: "${exchangeProperty.correlationId}"
        - toD:
            uri: "http://tax-platform-proxy:4010/submissions/vpd/${exchangeProperty.ackRef}?bridgeEndpoint=true"

        # Store submission response and extract customerId
        - setProperty:
            name: taxPlatformResponse
            simple: "${body}"
        - setProperty:
            name: customerId
            jsonpath:
              expression: "$.customerId"
              suppressExceptions: true

        # Log for debugging
        - log:
            message: "Tax-platform response received, customerId: ${exchangeProperty.customerId}"
            loggingLevel: INFO

        # Step 2: Call customer service to get trader details
        - removeHeaders:
            pattern: "CamelHttp*"
        - setHeader:
            name: CamelHttpMethod
            constant: "GET"
        - setHeader:
            name: X-Correlation-Id
            simple: "${exchangeProperty.correlationId}"
        - toD:
            uri: "http://customer-proxy:4010/customers/${exchangeProperty.customerId}?bridgeEndpoint=true"

        # Store customer response
        - setProperty:
            name: customerResponse
            simple: "${body}"

        - log:
            message: "Customer response received"
            loggingLevel: INFO

        # Step 3: Combine responses using Groovy
        - setBody:
            groovy: |
              import groovy.json.JsonSlurper
              import groovy.json.JsonOutput

              def slurper = new JsonSlurper()
              def submission = slurper.parseText(exchange.getProperty('taxPlatformResponse', String))
              def customer = slurper.parseText(exchange.getProperty('customerResponse', String))

              // Add trader field from customer data
              submission.trader = [
                name: customer.name,
                type: customer.type,
                address: customer.registeredAddress
              ]

              return JsonOutput.toJson(submission)

        # Set response headers
        - setHeader:
            name: Content-Type
            constant: "application/json"
        - setHeader:
            name: X-Correlation-Id
            simple: "${exchangeProperty.correlationId}"

# =============================================================================
# Route: GET by Approval Number + Period Key
# Simple pass-through for now (orchestration can be added later)
# =============================================================================

- route:
    id: getByApprovalAndPeriod
    from:
      uri: direct:getByApprovalAndPeriod
      steps:
        - removeHeaders:
            pattern: "CamelHttp*"
        - setHeader:
            name: X-Correlation-Id
            simple: "${exchangeProperty.correlationId}"
        - toD:
            uri: "http://tax-platform-proxy:4010/submissions/vpd?vpdApprovalNumber=${exchangeProperty.approvalNumber}&periodKey=${exchangeProperty.periodKey}&bridgeEndpoint=true"
        - setHeader:
            name: Content-Type
            constant: "application/json"
        - setHeader:
            name: X-Correlation-Id
            simple: "${exchangeProperty.correlationId}"

# =============================================================================
# Route: POST Submission - Pass-through
# =============================================================================

- route:
    id: postSubmission
    from:
      uri: direct:postSubmission
      steps:
        - setProperty:
            name: correlationId
            simple: "${header.X-Correlation-Id}"
        - setProperty:
            name: idempotencyKey
            simple: "${header.X-Idempotency-Key}"
        - setProperty:
            name: requestBody
            simple: "${body}"
        - removeHeaders:
            pattern: "CamelHttp*"
        - setHeader:
            name: X-Correlation-Id
            simple: "${exchangeProperty.correlationId}"
        - setHeader:
            name: X-Idempotency-Key
            simple: "${exchangeProperty.idempotencyKey}"
        - setHeader:
            name: Content-Type
            constant: "application/json"
        - setBody:
            simple: "${exchangeProperty.requestBody}"
        - to:
            uri: "http://tax-platform-proxy:4010/submissions/vpd?bridgeEndpoint=true"
        - setHeader:
            name: Content-Type
            constant: "application/json"
        - setHeader:
            name: X-Correlation-Id
            simple: "${exchangeProperty.correlationId}"

# =============================================================================
# Health check
# =============================================================================

- route:
    id: health
    from:
      uri: direct:health
      steps:
        - setHeader:
            name: Content-Type
            constant: "application/json"
        - setBody:
            constant: '{"status": "UP"}'
