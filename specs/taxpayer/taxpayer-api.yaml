openapi: 3.0.3
info:
  title: Taxpayer API
  version: 1.0.0
  description: |
    The Taxpayer API manages taxpayer identity and registration information within the UK tax system.
    
    This API provides endpoints for creating, retrieving, updating, and deleting taxpayer records,
    including personal details, National Insurance Numbers (NINO), and contact information.
    
    ## Key Features
    - Taxpayer registration and identity management
    - NINO validation and storage
    - Address and contact details management
    - Cross-API relationships to Income Tax and Payment APIs
    - Support for including related resources via the `include` parameter
    
    ## Relationships
    Taxpayer resources include links to:
    - **Tax Returns** (Income Tax API): Tax returns filed by the taxpayer
    - **Payments** (Payment API): Payments made by the taxpayer
    
    ## Version History
    - 1.0.0: Initial release with core taxpayer management functionality
  contact:
    name: UK Tax Domain API Team
    email: api-support@example.gov.uk

servers:
  - url: http://localhost:8080/api/taxpayer/v1
    description: Local development server
  - url: https://api.tax.service.gov.uk/api/taxpayer/v1
    description: Production server

security:
  - {}  # Allow unauthenticated access for POC

tags:
  - name: taxpayers
    description: Taxpayer identity and registration management

paths:
  /taxpayers:
    get:
      summary: List taxpayers
      description: |
        Retrieve a list of all taxpayers in the system.
        
        Supports filtering by various criteria and including related resources
        from other APIs using the `include` parameter.
      operationId: listTaxpayers
      tags:
        - taxpayers
      parameters:
        - name: nino
          in: query
          description: Filter by National Insurance Number
          required: false
          schema:
            type: string
            pattern: '^[A-Z]{2}[0-9]{6}[A-Z]$'
          example: "AB123456C"
        - name: lastName
          in: query
          description: Filter by last name (case-insensitive partial match)
          required: false
          schema:
            type: string
          example: "Smith"
        - $ref: '../shared/shared-components.yaml#/components/parameters/IncludeParameter'
      responses:
        '200':
          description: List of taxpayers retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - items
                  - _links
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Taxpayer'
                  _included:
                    type: object
                    description: |
                      Related resources included in the response when the `include` parameter is used.
                      Each property is a relationship name containing an array of related resources.
                    additionalProperties:
                      type: array
                      items:
                        type: object
                  _links:
                    type: object
                    required:
                      - self
                    properties:
                      self:
                        type: string
                        format: uri
              examples:
                withoutIncludes:
                  summary: List of taxpayers without includes
                  value:
                    items:
                      - id: "TP123456"
                        type: "taxpayer"
                        nino: "AB123456C"
                        name:
                          title: "Mr"
                          firstName: "John"
                          lastName: "Smith"
                        address:
                          line1: "10 Downing Street"
                          line2: "Westminster"
                          line3: "London"
                          postcode: "SW1A 2AA"
                          country: "GB"
                        dateOfBirth: "1980-05-15"
                        _links:
                          self: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
                          taxReturns:
                            href: "http://localhost:8080/api/income-tax/v1/tax-returns?taxpayerId=TP123456"
                            type: "collection"
                            title: "Tax returns for this taxpayer"
                          payments:
                            href: "http://localhost:8080/api/payment/v1/payments?taxpayerId=TP123456"
                            type: "collection"
                            title: "Payments made by this taxpayer"
                      - id: "TP789012"
                        type: "taxpayer"
                        nino: "CD789012E"
                        name:
                          firstName: "Jane"
                          lastName: "Doe"
                        address:
                          line1: "221B Baker Street"
                          postcode: "NW1 6XE"
                          country: "GB"
                        dateOfBirth: "1975-08-22"
                        _links:
                          self: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP789012"
                          taxReturns:
                            href: "http://localhost:8080/api/income-tax/v1/tax-returns?taxpayerId=TP789012"
                            type: "collection"
                            title: "Tax returns for this taxpayer"
                          payments:
                            href: "http://localhost:8080/api/payment/v1/payments?taxpayerId=TP789012"
                            type: "collection"
                            title: "Payments made by this taxpayer"
                    _links:
                      self: "http://localhost:8080/api/taxpayer/v1/taxpayers"
                withIncludes:
                  summary: List of taxpayers with included tax returns
                  value:
                    items:
                      - id: "TP123456"
                        type: "taxpayer"
                        nino: "AB123456C"
                        name:
                          title: "Mr"
                          firstName: "John"
                          lastName: "Smith"
                        address:
                          line1: "10 Downing Street"
                          line2: "Westminster"
                          line3: "London"
                          postcode: "SW1A 2AA"
                          country: "GB"
                        dateOfBirth: "1980-05-15"
                        _links:
                          self: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
                          taxReturns:
                            href: "http://localhost:8080/api/income-tax/v1/tax-returns?taxpayerId=TP123456"
                            type: "collection"
                            title: "Tax returns for this taxpayer"
                          payments:
                            href: "http://localhost:8080/api/payment/v1/payments?taxpayerId=TP123456"
                            type: "collection"
                            title: "Payments made by this taxpayer"
                    _included:
                      taxReturns:
                        - id: "TR20230001"
                          type: "tax-return"
                          taxpayerId: "TP123456"
                          taxYear: "2023-24"
                          status: "assessed"
                          totalIncome:
                            amount: 50000.00
                            currency: "GBP"
                          taxDue:
                            amount: 7500.00
                            currency: "GBP"
                          _links:
                            self: "http://localhost:8080/api/income-tax/v1/tax-returns/TR20230001"
                        - id: "TR20220001"
                          type: "tax-return"
                          taxpayerId: "TP123456"
                          taxYear: "2022-23"
                          status: "closed"
                          totalIncome:
                            amount: 48000.00
                            currency: "GBP"
                          taxDue:
                            amount: 7200.00
                            currency: "GBP"
                          _links:
                            self: "http://localhost:8080/api/income-tax/v1/tax-returns/TR20220001"
                    _links:
                      self: "http://localhost:8080/api/taxpayer/v1/taxpayers?include=taxReturns"
        '400':
          $ref: '../shared/shared-components.yaml#/components/responses/BadRequest'

    post:
      summary: Create a new taxpayer
      description: |
        Register a new taxpayer in the system.
        
        Requires a valid National Insurance Number (NINO) and complete address information.
        The NINO must be unique across all taxpayers.
      operationId: createTaxpayer
      tags:
        - taxpayers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaxpayerCreate'
            examples:
              minimal:
                summary: Minimal taxpayer creation
                value:
                  nino: "AB123456C"
                  name:
                    firstName: "John"
                    lastName: "Smith"
                  address:
                    line1: "10 Downing Street"
                    postcode: "SW1A 2AA"
                    country: "GB"
              complete:
                summary: Complete taxpayer creation with all fields
                value:
                  nino: "CD789012E"
                  name:
                    title: "Ms"
                    firstName: "Jane"
                    middleNames: "Elizabeth"
                    lastName: "Doe"
                  address:
                    line1: "221B Baker Street"
                    line2: "Marylebone"
                    line3: "London"
                    postcode: "NW1 6XE"
                    country: "GB"
                  dateOfBirth: "1975-08-22"
      responses:
        '201':
          description: Taxpayer created successfully
          headers:
            Location:
              description: URL of the newly created taxpayer
              schema:
                type: string
                format: uri
              example: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Taxpayer'
              example:
                id: "TP123456"
                type: "taxpayer"
                nino: "AB123456C"
                name:
                  title: "Mr"
                  firstName: "John"
                  lastName: "Smith"
                address:
                  line1: "10 Downing Street"
                  line2: "Westminster"
                  line3: "London"
                  postcode: "SW1A 2AA"
                  country: "GB"
                dateOfBirth: "1980-05-15"
                _links:
                  self: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
                  taxReturns:
                    href: "http://localhost:8080/api/income-tax/v1/tax-returns?taxpayerId=TP123456"
                    type: "collection"
                    title: "Tax returns for this taxpayer"
                  payments:
                    href: "http://localhost:8080/api/payment/v1/payments?taxpayerId=TP123456"
                    type: "collection"
                    title: "Payments made by this taxpayer"
        '400':
          $ref: '../shared/shared-components.yaml#/components/responses/BadRequest'

  /taxpayers/{id}:
    parameters:
      - name: id
        in: path
        description: Unique taxpayer identifier
        required: true
        schema:
          type: string
          pattern: '^TP[0-9]{6}$'
        example: "TP123456"

    get:
      summary: Get taxpayer details
      description: |
        Retrieve detailed information about a specific taxpayer.
        
        Supports including related resources from other APIs using the `include` parameter.
      operationId: getTaxpayer
      tags:
        - taxpayers
      parameters:
        - $ref: '../shared/shared-components.yaml#/components/parameters/IncludeParameter'
      responses:
        '200':
          description: Taxpayer details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaxpayerWithIncludes'
              examples:
                withoutIncludes:
                  summary: Taxpayer without includes
                  value:
                    id: "TP123456"
                    type: "taxpayer"
                    nino: "AB123456C"
                    name:
                      title: "Mr"
                      firstName: "John"
                      lastName: "Smith"
                    address:
                      line1: "10 Downing Street"
                      line2: "Westminster"
                      line3: "London"
                      postcode: "SW1A 2AA"
                      country: "GB"
                    dateOfBirth: "1980-05-15"
                    _links:
                      self: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
                      taxReturns:
                        href: "http://localhost:8080/api/income-tax/v1/tax-returns?taxpayerId=TP123456"
                        type: "collection"
                        title: "Tax returns for this taxpayer"
                      payments:
                        href: "http://localhost:8080/api/payment/v1/payments?taxpayerId=TP123456"
                        type: "collection"
                        title: "Payments made by this taxpayer"
                withIncludes:
                  summary: Taxpayer with included tax returns and payments
                  value:
                    id: "TP123456"
                    type: "taxpayer"
                    nino: "AB123456C"
                    name:
                      title: "Mr"
                      firstName: "John"
                      lastName: "Smith"
                    address:
                      line1: "10 Downing Street"
                      line2: "Westminster"
                      line3: "London"
                      postcode: "SW1A 2AA"
                      country: "GB"
                    dateOfBirth: "1980-05-15"
                    _links:
                      self: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
                      taxReturns:
                        href: "http://localhost:8080/api/income-tax/v1/tax-returns?taxpayerId=TP123456"
                        type: "collection"
                        title: "Tax returns for this taxpayer"
                      payments:
                        href: "http://localhost:8080/api/payment/v1/payments?taxpayerId=TP123456"
                        type: "collection"
                        title: "Payments made by this taxpayer"
                    _includes:
                      taxReturns: ["TR20230001"]
                      payments: ["PM20230001"]
                    _included:
                      taxReturns:
                        - id: "TR20230001"
                          type: "tax-return"
                          taxpayerId: "TP123456"
                          taxYear: "2023-24"
                          status: "assessed"
                          totalIncome:
                            amount: 50000.00
                            currency: "GBP"
                          taxDue:
                            amount: 7500.00
                            currency: "GBP"
                          _links:
                            self: "http://localhost:8080/api/income-tax/v1/tax-returns/TR20230001"
                            taxpayer:
                              href: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
                              type: "taxpayer"
                              title: "Taxpayer who filed this return"
                      payments:
                        - id: "PM20230001"
                          type: "payment"
                          taxpayerId: "TP123456"
                          amount:
                            amount: 7500.00
                            currency: "GBP"
                          paymentDate: "2024-01-31"
                          paymentMethod: "bank-transfer"
                          status: "cleared"
                          _links:
                            self: "http://localhost:8080/api/payment/v1/payments/PM20230001"
                            taxpayer:
                              href: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
                              type: "taxpayer"
                              title: "Taxpayer who made this payment"
        '404':
          $ref: '../shared/shared-components.yaml#/components/responses/NotFound'

    put:
      summary: Update taxpayer
      description: |
        Update all fields of an existing taxpayer.
        
        This is a full update operation - all required fields must be provided.
        Use PATCH for partial updates (not yet implemented).
      operationId: updateTaxpayer
      tags:
        - taxpayers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaxpayerUpdate'
            example:
              nino: "AB123456C"
              name:
                title: "Mr"
                firstName: "John"
                middleNames: "William"
                lastName: "Smith"
              address:
                line1: "11 Downing Street"
                line2: "Westminster"
                line3: "London"
                postcode: "SW1A 2AA"
                country: "GB"
              dateOfBirth: "1980-05-15"
      responses:
        '200':
          description: Taxpayer updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Taxpayer'
              example:
                id: "TP123456"
                type: "taxpayer"
                nino: "AB123456C"
                name:
                  title: "Mr"
                  firstName: "John"
                  middleNames: "William"
                  lastName: "Smith"
                address:
                  line1: "11 Downing Street"
                  line2: "Westminster"
                  line3: "London"
                  postcode: "SW1A 2AA"
                  country: "GB"
                dateOfBirth: "1980-05-15"
                _links:
                  self: "http://localhost:8080/api/taxpayer/v1/taxpayers/TP123456"
                  taxReturns:
                    href: "http://localhost:8080/api/income-tax/v1/tax-returns?taxpayerId=TP123456"
                    type: "collection"
                    title: "Tax returns for this taxpayer"
                  payments:
                    href: "http://localhost:8080/api/payment/v1/payments?taxpayerId=TP123456"
                    type: "collection"
                    title: "Payments made by this taxpayer"
        '400':
          $ref: '../shared/shared-components.yaml#/components/responses/BadRequest'
        '404':
          $ref: '../shared/shared-components.yaml#/components/responses/NotFound'

    delete:
      summary: Delete taxpayer
      description: |
        Delete a taxpayer from the system.
        
        Note: This operation may fail if the taxpayer has associated tax returns or payments.
        In production systems, consider soft deletion or archiving instead.
      operationId: deleteTaxpayer
      tags:
        - taxpayers
      responses:
        '204':
          description: Taxpayer deleted successfully
        '404':
          $ref: '../shared/shared-components.yaml#/components/responses/NotFound'
        '409':
          description: Cannot delete taxpayer with existing tax returns or payments
          content:
            application/json:
              schema:
                type: object
                required:
                  - error
                properties:
                  error:
                    type: object
                    required:
                      - code
                      - message
                      - status
                    properties:
                      code:
                        type: string
                        example: "CONFLICT"
                      message:
                        type: string
                        example: "Cannot delete taxpayer with existing tax returns or payments"
                      status:
                        type: integer
                        example: 409
              example:
                error:
                  code: "CONFLICT"
                  message: "Cannot delete taxpayer with existing tax returns or payments"
                  status: 409

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT bearer token authentication (not implemented in POC).
        
        In production, all endpoints would require authentication.

  schemas:
    Taxpayer:
      type: object
      description: |
        A taxpayer registered in the UK tax system.
        
        Contains personal identification information including National Insurance Number (NINO),
        name, address, and date of birth. Includes hypermedia links to related resources
        in other domain APIs.
      required:
        - id
        - type
        - nino
        - name
        - address
        - _links
      properties:
        id:
          type: string
          pattern: '^TP[0-9]{6}$'
          description: Unique taxpayer identifier
          example: "TP123456"
        type:
          type: string
          enum:
            - taxpayer
          description: Resource type identifier
          example: "taxpayer"
        nino:
          type: string
          pattern: '^[A-Z]{2}[0-9]{6}[A-Z]$'
          description: |
            National Insurance Number in standard UK format.
            
            Format: Two letters, six digits, one letter (e.g., AB123456C).
            Must be unique across all taxpayers.
          example: "AB123456C"
        name:
          type: object
          description: Taxpayer's name components
          required:
            - firstName
            - lastName
          properties:
            title:
              type: string
              enum:
                - Mr
                - Mrs
                - Miss
                - Ms
                - Dr
              description: Title or honorific
              example: "Mr"
            firstName:
              type: string
              description: First name (given name)
              example: "John"
              minLength: 1
              maxLength: 100
            middleNames:
              type: string
              description: Middle name(s) (optional)
              example: "William"
              maxLength: 100
            lastName:
              type: string
              description: Last name (surname/family name)
              example: "Smith"
              minLength: 1
              maxLength: 100
        address:
          $ref: '../shared/shared-components.yaml#/components/schemas/Address'
        dateOfBirth:
          type: string
          format: date
          description: Date of birth in ISO 8601 format (YYYY-MM-DD)
          example: "1980-05-15"
        _links:
          allOf:
            - $ref: '../shared/shared-components.yaml#/components/schemas/Links'
            - type: object
              description: |
                Hypermedia links to related resources.
                
                Includes links to:
                - self: This taxpayer resource
                - taxReturns: Tax returns filed by this taxpayer (Income Tax API)
                - payments: Payments made by this taxpayer (Payment API)
              properties:
                taxReturns:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to the taxpayer's tax returns
                      example: "http://localhost:8080/api/income-tax/v1/tax-returns?taxpayerId=TP123456"
                    type:
                      type: string
                      enum:
                        - collection
                      example: "collection"
                    title:
                      type: string
                      example: "Tax returns for this taxpayer"
                payments:
                  type: object
                  required:
                    - href
                  properties:
                    href:
                      type: string
                      format: uri
                      description: URL to the taxpayer's payments
                      example: "http://localhost:8080/api/payment/v1/payments?taxpayerId=TP123456"
                    type:
                      type: string
                      enum:
                        - collection
                      example: "collection"
                    title:
                      type: string
                      example: "Payments made by this taxpayer"

    TaxpayerWithIncludes:
      allOf:
        - $ref: '#/components/schemas/Taxpayer'
        - type: object
          description: Taxpayer with optional included related resources
          properties:
            _includes:
              type: object
              description: |
                References to included resources by relationship name.
                Each property contains an array of IDs referencing resources in _included.
              properties:
                taxReturns:
                  type: array
                  items:
                    type: string
                    pattern: '^TR[0-9]{8}$'
                  example: ["TR20230001", "TR20220001"]
                payments:
                  type: array
                  items:
                    type: string
                    pattern: '^PM[0-9]{8}$'
                  example: ["PM20230001"]
            _included:
              type: object
              description: |
                Related resources included in the response.
                Each property is a relationship name containing an array of related resources.
              properties:
                taxReturns:
                  type: array
                  description: Tax returns filed by this taxpayer
                  items:
                    type: object
                    description: Tax return resource from Income Tax API
                payments:
                  type: array
                  description: Payments made by this taxpayer
                  items:
                    type: object
                    description: Payment resource from Payment API

    TaxpayerCreate:
      type: object
      description: Request body for creating a new taxpayer
      required:
        - nino
        - name
        - address
      properties:
        nino:
          type: string
          pattern: '^[A-Z]{2}[0-9]{6}[A-Z]$'
          description: National Insurance Number (must be unique)
          example: "AB123456C"
        name:
          type: object
          required:
            - firstName
            - lastName
          properties:
            title:
              type: string
              enum:
                - Mr
                - Mrs
                - Miss
                - Ms
                - Dr
              example: "Mr"
            firstName:
              type: string
              minLength: 1
              maxLength: 100
              example: "John"
            middleNames:
              type: string
              maxLength: 100
              example: "William"
            lastName:
              type: string
              minLength: 1
              maxLength: 100
              example: "Smith"
        address:
          $ref: '../shared/shared-components.yaml#/components/schemas/Address'
        dateOfBirth:
          type: string
          format: date
          description: Date of birth in ISO 8601 format
          example: "1980-05-15"

    TaxpayerUpdate:
      type: object
      description: Request body for updating an existing taxpayer
      required:
        - nino
        - name
        - address
      properties:
        nino:
          type: string
          pattern: '^[A-Z]{2}[0-9]{6}[A-Z]$'
          description: National Insurance Number
          example: "AB123456C"
        name:
          type: object
          required:
            - firstName
            - lastName
          properties:
            title:
              type: string
              enum:
                - Mr
                - Mrs
                - Miss
                - Ms
                - Dr
              example: "Mr"
            firstName:
              type: string
              minLength: 1
              maxLength: 100
              example: "John"
            middleNames:
              type: string
              maxLength: 100
              example: "William"
            lastName:
              type: string
              minLength: 1
              maxLength: 100
              example: "Smith"
        address:
          $ref: '../shared/shared-components.yaml#/components/schemas/Address'
        dateOfBirth:
          type: string
          format: date
          description: Date of birth in ISO 8601 format
          example: "1980-05-15"
