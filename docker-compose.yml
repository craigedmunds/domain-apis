services:
  localstack:
    image: localstack/localstack:latest
    container_name: domain-api-localstack
    ports:
      - "4566:4566"  # LocalStack gateway
      - "4510-4559:4510-4559"  # External services port range
    environment:
      - SERVICES=apigateway,lambda,iam,cloudformation
      - DEBUG=1
      - LAMBDA_EXECUTOR=docker
      - DOCKER_HOST=unix:///var/run/docker.sock
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./tools:/tools"
    networks:
      - domain-api-network

  docs:
    image: halverneus/static-file-server:latest
    container_name: domain-api-docs
    ports:
      - "8080:8080"
    volumes:
      - ./docs:/web
      - ./specs:/web/specs
    environment:
      - FOLDER=/web
      - PORT=8080
      - SHOW_LISTING=true
    networks:
      - domain-api-network

  taxpayer-api:
    image: stoplight/prism:latest
    container_name: domain-api-taxpayer
    command: mock -h 0.0.0.0 /specs/taxpayer-api.yaml
    ports:
      - "8081:4010"
    volumes:
      - ./specs/taxpayer:/specs
      - ./specs/shared:/shared
    environment:
      - PRISM_LOG_LEVEL=info
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4010"]
      interval: 10s
      timeout: 5s
      retries: 3

  income-tax-api:
    image: stoplight/prism:latest
    container_name: domain-api-income-tax
    command: mock -h 0.0.0.0 /specs/income-tax-api.yaml
    ports:
      - "8082:4010"
    volumes:
      - ./specs/income-tax:/specs
      - ./specs/shared:/shared
    environment:
      - PRISM_LOG_LEVEL=info
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4010"]
      interval: 10s
      timeout: 5s
      retries: 3

  payment-api:
    image: stoplight/prism:latest
    container_name: domain-api-payment
    command: mock -h 0.0.0.0 /specs/payment-api.yaml
    ports:
      - "8083:4010"
    volumes:
      - ./specs/payment:/specs
      - ./specs/shared:/shared
    environment:
      - PRISM_LOG_LEVEL=info
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4010"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  domain-api-network:
    driver: bridge
