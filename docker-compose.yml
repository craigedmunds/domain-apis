# Domain APIs - Docker Compose
#
# VPD Submission Returns POC stack:
# - Domain API (JBang + Camel YAML DSL): Orchestration service
# - excise mock (WireMock): Returns XML (legacy system simulation)
# - customer mock (Prism): Returns JSON
# - tax-platform mock (Prism): Returns JSON
# - Logging proxies (Envoy): Request logging, tracing, CORS
# - LGTM observability stack: Loki, Grafana, Tempo, Mimir
# - k6 for load testing
#
# Architecture:
#   External ports → Domain API → Envoy proxies → Mocks (internal)
#
# Usage:
#   docker-compose up -d                 # Start all services
#   docker-compose logs -f domain-api    # Follow domain API logs
#   docker-compose run k6 run /tests/smoke-test-mocks.js  # Run tests
#   docker-compose down                  # Stop and remove containers

services:

  # =============================================================================
  # Domain API (Apache Camel JBang + YAML DSL) - Internal
  # =============================================================================

  domain-api-internal:
    image: apache/camel-jbang:4.16.0
    container_name: vpd-domain-api-internal
    command: >
      run /routes/integration.yaml
      --dep=org.apache.camel:camel-jacksonxml
    volumes:
      - ./specs/vaping-duty/domain/platform/routes:/routes:ro
    networks:
      - domain-api-network
    depends_on:
      - excise-proxy
      - customer-proxy
      - tax-platform-proxy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 90s

  # =============================================================================
  # Domain API Proxy (Envoy) - CORS, logging, tracing
  # =============================================================================

  domain-api-proxy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: vpd-domain-api-proxy
    ports:
      - "8081:8080"
      - "9900:9901"
    volumes:
      - ./config/envoy/envoy-domain-api.yaml:/etc/envoy/envoy.yaml:ro
    depends_on:
      domain-api-internal:
        condition: service_healthy
      lgtm:
        condition: service_started
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-external-labels: "service=domain-api-proxy,job=envoy"
    networks:
      - domain-api-network

  # =============================================================================
  # Docs / Try It Site
  # =============================================================================

  docs:
    image: halverneus/static-file-server:latest
    container_name: domain-api-docs
    ports:
      - "8080:8080"
    volumes:
      - ./docs:/web
      - ./specs:/web/specs
    environment:
      - FOLDER=/web
      - PORT=8080
      - SHOW_LISTING=true
    networks:
      - domain-api-network

  # =============================================================================
  # VPD Backend Mocks - Internal (accessed via proxies)
  # =============================================================================

  # Excise mock uses WireMock for XML support
  excise-mock-internal:
    image: wiremock/wiremock:3.3.1
    container_name: vpd-excise-mock-internal
    volumes:
      - ./specs/vaping-duty/mocks/wiremock:/home/wiremock
    command: --verbose --enable-stub-cors
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/__admin/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Customer mock uses Prism (JSON only)
  customer-mock-internal:
    image: stoplight/prism:latest
    container_name: vpd-customer-mock-internal
    command: mock -h 0.0.0.0 /specs/customer-api.yaml
    volumes:
      - ./specs/vaping-duty/mocks:/specs
    environment:
      - PRISM_LOG_LEVEL=info
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://127.0.0.1:4010/customers/CUST789', r => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # Tax Platform mock uses Prism (JSON only)
  tax-platform-mock-internal:
    image: stoplight/prism:latest
    container_name: vpd-tax-platform-mock-internal
    command: mock -h 0.0.0.0 /specs/tax-platform-api.yaml
    volumes:
      - ./specs/vaping-duty/mocks:/specs
    environment:
      - PRISM_LOG_LEVEL=info
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://127.0.0.1:4010/submissions/vpd/ACK-2026-01-26-000123', r => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # =============================================================================
  # Logging Proxies (Envoy) - External access with tracing
  # =============================================================================

  excise-proxy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: vpd-excise-proxy
    ports:
      - "4010:4010"
      - "9901:9901"
    volumes:
      - ./config/envoy/envoy-excise.yaml:/etc/envoy/envoy.yaml:ro
    depends_on:
      excise-mock-internal:
        condition: service_healthy
      lgtm:
        condition: service_started
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-external-labels: "service=excise-proxy,job=envoy"
    networks:
      - domain-api-network

  customer-proxy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: vpd-customer-proxy
    ports:
      - "4011:4010"
      - "9902:9901"
    volumes:
      - ./config/envoy/envoy-customer.yaml:/etc/envoy/envoy.yaml:ro
    depends_on:
      customer-mock-internal:
        condition: service_healthy
      lgtm:
        condition: service_started
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-external-labels: "service=customer-proxy,job=envoy"
    networks:
      - domain-api-network

  tax-platform-proxy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: vpd-tax-platform-proxy
    ports:
      - "4012:4010"
      - "9903:9901"
    volumes:
      - ./config/envoy/envoy-tax-platform.yaml:/etc/envoy/envoy.yaml:ro
    depends_on:
      tax-platform-mock-internal:
        condition: service_healthy
      lgtm:
        condition: service_started
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-external-labels: "service=tax-platform-proxy,job=envoy"
    networks:
      - domain-api-network

  # =============================================================================
  # Observability Stack (LGTM)
  # =============================================================================

  lgtm:
    image: grafana/otel-lgtm:latest
    container_name: vpd-lgtm
    ports:
      - "3000:3000"   # Grafana UI
      - "3100:3100"   # Loki API (for Promtail)
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
    networks:
      - domain-api-network

  # =============================================================================
  # Testing
  # =============================================================================

  k6:
    image: grafana/k6:latest
    container_name: vpd-k6
    volumes:
      - ./tests/load:/tests
    environment:
      - DOMAIN_API_URL=http://domain-api-proxy:8080
      - EXCISE_URL=http://excise-proxy:4010
      - CUSTOMER_URL=http://customer-proxy:4010
      - TAX_PLATFORM_URL=http://tax-platform-proxy:4010
    networks:
      - domain-api-network
    profiles:
      - test
    depends_on:
      - domain-api-proxy
      - excise-proxy
      - customer-proxy
      - tax-platform-proxy

networks:
  domain-api-network:
    driver: bridge
