# Domain APIs - Docker Compose
#
# VPD Submission Returns POC stack:
# - Backend mocks (Prism): excise, customer, tax-platform
# - LGTM observability stack: Loki, Grafana, Tempo, Mimir
# - API Explorer (Swagger UI)
# - LocalStack (for future API Gateway integration)
# - Docs server
#
# Usage:
#   docker-compose up                    # Start all services
#   docker-compose up -d                 # Start in background
#   docker-compose logs -f excise-mock   # Follow logs for a service
#   docker-compose down                  # Stop and remove containers

services:
  # =============================================================================
  # VPD Backend Mocks (Prism)
  # =============================================================================

  excise-mock:
    image: stoplight/prism:latest
    container_name: vpd-excise-mock
    command: mock -h 0.0.0.0 /specs/excise-api.yaml
    ports:
      - "4010:4010"
    volumes:
      - ./specs/vaping-duty/mocks:/specs
    environment:
      - PRISM_LOG_LEVEL=info
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4010/excise/vpd/registrations/VPD123456"]
      interval: 10s
      timeout: 5s
      retries: 3

  customer-mock:
    image: stoplight/prism:latest
    container_name: vpd-customer-mock
    command: mock -h 0.0.0.0 /specs/customer-api.yaml
    ports:
      - "4011:4010"
    volumes:
      - ./specs/vaping-duty/mocks:/specs
    environment:
      - PRISM_LOG_LEVEL=info
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4010/customers/CUST789"]
      interval: 10s
      timeout: 5s
      retries: 3

  tax-platform-mock:
    image: stoplight/prism:latest
    container_name: vpd-tax-platform-mock
    command: mock -h 0.0.0.0 /specs/tax-platform-api.yaml
    ports:
      - "4012:4010"
    volumes:
      - ./specs/vaping-duty/mocks:/specs
    environment:
      - PRISM_LOG_LEVEL=info
    networks:
      - domain-api-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4010/submissions/vpd/ACK-2026-01-26-000123"]
      interval: 10s
      timeout: 5s
      retries: 3

  # =============================================================================
  # Observability Stack (LGTM)
  # =============================================================================

  lgtm:
    image: grafana/otel-lgtm:latest
    container_name: vpd-lgtm
    ports:
      - "3000:3000"   # Grafana UI
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
    networks:
      - domain-api-network

  # =============================================================================
  # Infrastructure
  # =============================================================================

  docs:
    image: halverneus/static-file-server:latest
    container_name: domain-api-docs
    ports:
      - "8080:8080"
    volumes:
      - ./docs:/web
      - ./specs:/web/specs
    environment:
      - FOLDER=/web
      - PORT=8080
      - SHOW_LISTING=true
    networks:
      - domain-api-network

networks:
  domain-api-network:
    driver: bridge
